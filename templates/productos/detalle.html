{% extends "base.html" %}

{% block title %}{{ producto.nombre }}{% endblock %}

{% block content %}
<h2>{{ producto.nombre }}</h2>

<p><strong>Productor:</strong> {{ producto.productor.user.username }}</p>
<p><strong>Descripción:</strong> {{ producto.descripcion }}</p>
<p><strong>Precio unitario:</strong> {{ producto.precio_unitario }}</p>
<p><strong>Stock:</strong> {{ producto.stock }}</p>
<p><strong>País de origen:</strong> {{ producto.pais_origen }}</p>
<h3>Incoterms aplicables</h3>
{% if producto.incoterms.all %}
    <ul>
        {% for inc in producto.incoterms.all %}
            <li>
                <strong>{{ inc.codigo }}</strong> - {{ inc.nombre }}<br>
                <small>{{ inc.descripcion|default:"" }}</small>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p>Este producto no tiene incoterms asociados todavía.</p>
{% endif %}

<h3>Normativa comercial asociada</h3>
{% if producto.normas_comerciales.all %}
    <ul>
        {% for norma in producto.normas_comerciales.all %}
            <li>
                <strong>{{ norma.pais }} - {{ norma.get_tipo_display }}</strong>
                {% if norma.categoria_producto %}
                    ({{ norma.categoria_producto }})
                {% endif %}
                <br>
                <small>{{ norma.descripcion }}</small>
                {% if norma.enlace_oficial %}
                    <br>
                    <a href="{{ norma.enlace_oficial }}" target="_blank">Ver enlace oficial</a>
                {% endif %}
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p>No se ha asociado normativa específica para este producto.</p>
{% endif %}

<p>
    <a href="{% url 'lista_incoterms' %}">Ver todos los Incoterms</a> |
    <a href="{% url 'lista_normativa' %}">Ver toda la normativa</a>
</p>


<hr>

<h3>Operaciones y documentos asociados</h3>

{% if operaciones %}
    <ul>
        {% for op in operaciones %}
            <li>
                {{ op.get_tipo_operacion_display }} -
                {{ op.empresa.user.username }} -
                {{ op.fecha_creacion }}

                {% with docs=op.documentos.all %}
                    {% if docs %}
                        <ul>
                            {% for doc in docs %}
                                <li>
                                    {{ doc.get_tipo_display }} -
                                    {% if doc.archivo %}
                                        <a href="{{ doc.archivo.url }}" target="_blank">Ver documento</a>
                                    {% else %}
                                        (sin archivo)
                                    {% endif %}
                                    {% if doc.descripcion %}
                                        - {{ doc.descripcion }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        (Sin documentos)
                    {% endif %}
                {% endwith %}
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p>No hay operaciones registradas para este producto.</p>
{% endif %}

<hr>

{# Si es empresa logueada, puede solicitar operación #}
{% if user.is_authenticated and user.perfil.rol == 'empresa' %}
    <p>
        <a href="{% url 'crear_operacion' producto.pk %}">
            Solicitar operación comercial
        </a>
    </p>
{% elif not user.is_authenticated %}
    <p>
        Para solicitar una operación comercial, debes
        <a href="{% url 'login' %}?next={% url 'detalle_producto' producto.pk %}">iniciar sesión</a>.
    </p>
{% endif %}

{# Si es el productor dueño del producto, puede editarlo #}
{% if user.is_authenticated and user.perfil == producto.productor %}
    <p>
        <a href="{% url 'editar_producto' producto.pk %}">Editar este producto</a>
    </p>
{% endif %}

<a href="{% url 'lista_productos' %}">← Volver al listado</a>
{% endblock %}
